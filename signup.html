<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Criar conta - Anoig</title>
  <link rel="stylesheet" href="style.css?v=3">
  <style>
    html, body { height: 100%; }
    body {
      margin:0; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:16px;
      background:
        radial-gradient(900px 600px at 50% 20%, rgba(154,208,214,.22), transparent 70%),
        radial-gradient(1200px 800px at 15% 10%, rgba(19,66,71,.35), transparent 70%),
        #0f1b1e;
    }
    .auth-card {
      width: 100%; max-width: 520px;
      background: #9ad0d6; /* verde claro do card */
      color:#0f1b1e; /* texto mais escuro */
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px; padding:24px;
      box-shadow:
        0 18px 50px rgba(0,0,0,.45),
        0 8px 22px rgba(0,0,0,.22),
        0 1px 0 rgba(255,255,255,.4) inset;
    }
    .logo-top { width:100%; display:flex; align-items:center; justify-content:center; margin-bottom:12px; }
    .logo-top .logo-box { width: 180px; max-width: 80%; height: 68px; border-radius: 10px; overflow: hidden; display:flex; align-items:center; justify-content:center; }
    .logo-top .logo-box img { width:100%; height:100%; object-fit:contain; display:block; }
    .muted { color:#0b3d42; font-size:.9em; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .form label { display:block; color:#0f1b1e; font-size:.95em; margin: 10px 0 6px; font-weight:600; }
    .form input {
      width:100%; background:#ffffff; color:#0f1b1e;
      border:1px solid rgba(11,61,66,.25); border-radius:10px;
      padding:12px 12px; outline:none;
      box-shadow: 0 1px 0 rgba(255,255,255,.6) inset, 0 6px 14px rgba(0,0,0,.06);
    }
    .form input:focus { border-color:#25D366; box-shadow: 0 0 0 3px rgba(37,211,102,.22), 0 1px 0 rgba(255,255,255,.6) inset; }
    .form input::placeholder { color:#486a6f; }
    .btn.primary { background:#25D366; color:#fff; border:none; border-radius:10px; padding:12px 16px; font-weight:700; box-shadow: 0 6px 14px rgba(37,211,102,.35); }
    .btn.primary:hover { background:#1ebe57; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tyhoonmssqxbtktiuwtd.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aG9vbm1zc3F4YnRrdGl1d3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Mjg5MTgsImV4cCI6MjA3MzAwNDkxOH0.e-vVW5CSihmFlYGpvms0KLCrhqxdCqujJxhT6a-nBpI";
    const supa = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
    async function doSignup(e){
      e.preventDefault();
      const fullName = document.getElementById('sgName').value.trim();
      const email    = document.getElementById('sgEmail').value.trim();
      const whatsapp = document.getElementById('sgWhatsapp').value.trim();
      const address  = document.getElementById('sgAddress').value.trim();
      const pass     = document.getElementById('sgPass').value;
      const pass2    = document.getElementById('sgPass2').value;
      const msg = document.getElementById('msg'); msg.textContent='';
      if(pass !== pass2){ msg.textContent='As senhas não conferem.'; return; }
      if(!supa){ msg.textContent='SDK indisponível'; return; }
      const { data, error } = await supa.auth.signUp({
        email,
        password: pass,
        options: {
          data: { full_name: fullName, whatsapp, address },
          emailRedirectTo: location.origin + '/index.html'
        }
      });
      if(error){ msg.textContent = error.message || 'Falha ao criar conta.'; return; }
      msg.textContent = 'Cadastro iniciado. Verifique seu e-mail para confirmar a conta.';
    }
    function backLogin(){ location.href = 'login.html'; }
    document.addEventListener('DOMContentLoaded', ()=>{
      const back = document.getElementById('backLogin'); if(back){ back.addEventListener('click', backLogin); }
    });
  </script>
  <script>
    // Override doSignup para aceitar username e validar disponibilidade
    (function(){
      const SUPABASE_URL = "https://tyhoonmssqxbtktiuwtd.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5aG9vbm1zc3F4YnRrdGl1d3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Mjg5MTgsImV4cCI6MjA3MzAwNDkxOH0.e-vVW5CSihmFlYGpvms0KLCrhqxdCqujJxhT6a-nBpI";
      const supa2 = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
      function sanitizeUsername(s){
        s = String(s||'').trim().toLowerCase();
        try{ if(s.normalize) s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch(_){ }
        return s.replace(/[^a-z0-9._-]/g, '');
      }
      window.doSignup = async function(e){
        e.preventDefault();
        const msg = document.getElementById('msg'); if(msg) msg.textContent='';
        try{
          const fullName = document.getElementById('sgName').value.trim();
          let username = document.getElementById('sgUsername').value.trim();
          const email    = document.getElementById('sgEmail').value.trim();
          const whatsapp = document.getElementById('sgWhatsapp').value.trim();
          const address  = document.getElementById('sgAddress').value.trim();
          const pass     = document.getElementById('sgPass').value;
          const pass2    = document.getElementById('sgPass2').value;
          if(pass !== pass2){ msg.textContent='As senhas não conferem.'; return; }
          if(!supa2){ msg.textContent='SDK indisponível'; return; }
          username = sanitizeUsername(username);
          if(!username){ msg.textContent='Informe um nome de usuário válido (letras/números/._-).'; return; }
          try{
            const { data: exists, error: qErr } = await supa2.from('profiles').select('id').eq('username', username).limit(1);
            if(qErr){ /* tabela pode não existir ainda; ignora */ }
            if(exists && exists.length){ msg.textContent='Nome de usuário indisponível.'; return; }
          }catch(_){ }
          const { error } = await supa2.auth.signUp({
            email,
            password: pass,
            options: {
              data: { full_name: fullName, whatsapp, address, username },
              emailRedirectTo: location.origin + '/index.html'
            }
          });
          if(error){ msg.textContent = error.message || 'Falha ao criar conta.'; return; }
          msg.textContent = 'Cadastro iniciado. Verifique seu e-mail para confirmar a conta. Dica: no primeiro acesso, entre com seu e-mail; depois, o login por usuário ficará disponível.';
        }catch(err){ console.error(err); if(msg) msg.textContent='Falha ao criar conta.'; }
      };
      document.addEventListener('DOMContentLoaded', ()=>{
        const u = document.getElementById('sgUsername');
        if(u){ u.addEventListener('input', (e)=>{ e.target.value = sanitizeUsername(e.target.value); }); }
        // rebind form to the override
        const f = document.getElementById('signupForm'); if(f){ f.addEventListener('submit', window.doSignup); }
      });
    })();
  </script>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16.png">
  <style>:root { color-scheme: light dark; }</style>
  </head>
<body>
  <div class="auth-card">
    <div class="logo-top"><div class="logo-box"><img src="assets/logo-transparent.png" alt="Logo"></div></div>
    <div class="muted" style="text-align:center; margin:-6px 0 8px">Crie sua conta</div>

    <form id="signupForm" class="form">
      <label>Nome completo
        <input id="sgName" type="text" placeholder="Seu nome" required>
      </label>
      <label>Nome de usuário
        <input id="sgUsername" type="text" placeholder="letras, números, . _ -" required>
      </label>
      <label>E-mail
        <input id="sgEmail" type="email" placeholder="seuemail@exemplo.com" required>
      </label>
      <label>WhatsApp
        <input id="sgWhatsapp" type="text" placeholder="(xx) xxxxx-xxxx" required>
      </label>
      <label>Endereço completo
        <input id="sgAddress" type="text" placeholder="Rua, nº, bairro, cidade, UF, CEP" required>
      </label>
      <div class="grid-2">
        <label>Senha
          <input id="sgPass" type="password" placeholder="Senha" required>
        </label>
        <label>Confirmar senha
          <input id="sgPass2" type="password" placeholder="Repita a senha" required>
        </label>
      </div>
      <div class="btn-row" style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" type="button" id="backLogin">Voltar</button>
        <button class="btn primary" type="submit">Criar conta</button>
      </div>
    </form>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>
  </body>
</html>
